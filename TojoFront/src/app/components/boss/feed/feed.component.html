<div class="parent">
    <div class="filters-row">
        <!-- div1: filtro de sensores activos -->
        <div class="div1" [class.filtro-activo]="filtroActual === 'activos'" (click)="cambiarFiltro('activos')">
            <h3>Sensores Activos</h3>
            <span class="contador">{{ getSensoresActivos() }}</span>
        </div>

        <!-- div2: filtro de sensores inactivos -->
        <div class="div2" [class.filtro-activo]="filtroActual === 'inactivos'" (click)="cambiarFiltro('inactivos')">
            <h3>Sensores Inactivos</h3>
            <span class="contador">{{ getSensoresInactivos() }}</span>
        </div>

        <!-- div3: bot√≥n para agregar sensor -->
        <div class="div3">
            <button class="btn-agregar" (click)="openAddSensorModal()">
                <span>‚ûï</span>
                Agregar Sensor
            </button>
        </div>
    </div>

    <!-- Disposici√≥n estilo original (3 columnas, m√∫ltiples filas) mostrando todos -->
    <div class="sensores-fixed-layout">
        <div *ngFor="let sensor of getSensoresFiltrados(); let i = index" class="tarjeta-sensor sensor-appear"
            [attr.data-key]="getSensorKey(i)"
            [style.animationDelay]="(i * 90) + 'ms'" [class.sensor-activo]="isSensorActivo(i)"
            [class.sensor-inactivo]="!isSensorActivo(i)">
            <button class="btn-toggle-esquina" [class.toggle-activo]="!isSensorActivo(i)"
                [class.toggle-inactivo]="isSensorActivo(i)" (click)="toggleSensor(i)">
                {{ isSensorActivo(i) ? 'OFF' : 'ON' }}
            </button>
            <button class="btn-delete-esquina" type="button" title="Eliminar sensor" (click)="openDeleteModal(i)">
                üóëÔ∏è
            </button>
            <button class="btn-edit-esquina" type="button" title="Editar sensor" (click)="openEditModal(i)">
                ‚úèÔ∏è
            </button>
            <div class="sensor-body">
                <div class="sensor-top">
                    <div class="sensor-icon">üì°</div>
                </div>
                <h4 class="sensor-name">{{ sensor }}</h4>
                                <span class="sensor-status">Estado: {{ isSensorActivo(i) ? 'Activo' : 'Inactivo' }}</span>
                                <button type="button" class="sensor-key" [class.copiado]="copiedKeyIndex === i" (click)="copyKey(i)" title="Click para copiar">
                                    <span class="label">KEY</span>
                                    <span class="valor" *ngIf="copiedKeyIndex !== i">{{ getSensorKey(i) }}</span>
                                    <span class="valor copiado-text" *ngIf="copiedKeyIndex === i">Copiado!</span>
                                    <span class="icono" aria-hidden="true">üìã</span>
                                </button>
                <button class="btn-datos-tarjeta" (click)="verDatosSensor(i)">Ver Datos</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de datos del sensor -->
<app-modal-data [isVisible]="modalVisible" [sensorId]="sensorSeleccionado.id" [sensorName]="sensorSeleccionado.nombre"
    [sensorData]="sensorDataForModal" (closeModal)="cerrarModal()" (dataUpdated)="onDatosActualizados($event)" (refreshData)="onRefreshSensorData()">
</app-modal-data>

<!-- Modal confirmaci√≥n eliminar sensor -->
<div class="delete-confirm-backdrop" *ngIf="showDeleteModal">
    <div class="delete-confirm-modal">
        <div class="delete-header">CONFIRMAR ELIMINACI√ìN</div>
        <div class="delete-body">
            <p>
                ¬øSeguro que deseas eliminar el sensor
                <span class="sensor-tag">{{ sensorAEliminar?.nombre }}</span>?<br>
                Esta acci√≥n no se puede deshacer.
            </p>
            <div class="delete-warning">Se perder√° la configuraci√≥n asociada.</div>
        </div>
        <div class="delete-actions">
            <button class="btn-cancel-del" (click)="cancelDelete()">Cancelar</button>
            <button class="btn-confirm-del" (click)="confirmDelete()" [disabled]="deleting">
                <span *ngIf="!deleting">Eliminar</span>
                <span *ngIf="deleting" class="spinner small"></span>
            </button>
        </div>
    </div>
</div>

<!-- Modal agregar nuevo sensor -->
<div class="add-sensor-backdrop" *ngIf="showAddSensorModal">
    <div class="add-sensor-modal">
        <div class="add-sensor-header">Registrar Nuevo Sensor</div>
        <div class="add-sensor-disclaimer">
            <strong>Importante:</strong> Antes de registrar aqu√≠ el sensor debes crearlo previamente en <span
                class="adafruit">Adafruit IO</span> y obtener su <code>KEY</code> / feed.
        </div>
        <form (ngSubmit)="guardarNuevoSensor()" class="add-sensor-form" autocomplete="off">
            <div class="form-row">
                <label for="sensorKey">Key del Sensor *</label>
                <input id="sensorKey" type="text" [(ngModel)]="nuevoSensor.key" name="sensorKey" maxlength="100"
                    placeholder="Ej: a1b2c3d4-feed" required />
            </div>
            <div class="form-row">
                <label for="sensorNombre">Nombre del Sensor *</label>
                <input id="sensorNombre" type="text" [(ngModel)]="nuevoSensor.nombre" name="sensorNombre" maxlength="40"
                    placeholder="Ej: Temp Bodega" required />
            </div>
            <div class="form-row inline">
                <label class="switch-label">Estado</label>
                <label class="switch">
                    <input type="checkbox" [(ngModel)]="nuevoSensor.activo" name="sensorActivo" />
                    <span class="slider"></span>
                    <span class="switch-text">{{ nuevoSensor.activo ? 'Activo' : 'Inactivo' }}</span>
                </label>
            </div>
            <div class="form-row">
                <label for="tipoDato">Tipo de Dato</label>
                <select id="tipoDato" [(ngModel)]="nuevoSensor.tipoDato" name="tipoDato">
                    <option *ngFor="let t of tiposDato" [value]="t.value">{{ t.label }}</option>
                </select>
            </div>
            <div *ngIf="!isTipoBooleano(nuevoSensor.tipoDato)" class="form-row dual"
                [ngClass]="{'range-invalid': nuevoSensor.minValue !== null && nuevoSensor.maxValue !== null && nuevoSensor.minValue > nuevoSensor.maxValue}">
                <div class="dual-field min-field">
                    <label for="minValue">Valor M√≠nimo</label>
                    <div class="input-wrapper">
                        <span class="prefix">MIN</span>
                        <input id="minValue" type="number" step="0.0001" [(ngModel)]="nuevoSensor.minValue"
                            name="minValue" placeholder="Ej: 0" />
                    </div>
                </div>
                <div class="dual-field max-field">
                    <label for="maxValue">Valor M√°ximo</label>
                    <div class="input-wrapper">
                        <span class="prefix">MAX</span>
                        <input id="maxValue" type="number" step="0.0001" [(ngModel)]="nuevoSensor.maxValue"
                            name="maxValue" placeholder="Ej: 100" />
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" (click)="closeAddSensorModal()"
                    [disabled]="savingSensor">Cancelar</button>
                <button type="submit" class="btn-save"
                    [disabled]="savingSensor || !nuevoSensor.key.trim() || !nuevoSensor.nombre.trim()">
                    <span *ngIf="!savingSensor">Guardar</span>
                    <span *ngIf="savingSensor" class="spinner"></span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal editar sensor -->
<div class="edit-sensor-backdrop" *ngIf="showEditSensorModal">
    <div class="edit-sensor-modal">
        <div class="edit-sensor-header">Editar Sensor</div>
        <div class="edit-sensor-disclaimer">
            Modifica los campos que necesites actualizar. La <strong>KEY</strong> no se puede cambiar una vez creado el sensor.
        </div>
        <form (ngSubmit)="guardarEdicionSensor()" class="edit-sensor-form" autocomplete="off">
            <div class="form-row">
                <label for="editSensorKey">Key del Sensor</label>
                <input id="editSensorKey" type="text" [(ngModel)]="editarSensor.key" name="editSensorKey" 
                    maxlength="100" readonly class="readonly-input" 
                    title="La key no se puede modificar" />
            </div>
            <div class="form-row">
                <label for="editSensorNombre">Nombre del Sensor *</label>
                <input id="editSensorNombre" type="text" [(ngModel)]="editarSensor.nombre" name="editSensorNombre" 
                    maxlength="40" placeholder="Ej: Temp Bodega" required />
            </div>
            <div class="form-row inline">
                <label class="switch-label">Estado</label>
                <label class="switch">
                    <input type="checkbox" [(ngModel)]="editarSensor.activo" name="editSensorActivo" />
                    <span class="slider"></span>
                    <span class="switch-text">{{ editarSensor.activo ? 'Activo' : 'Inactivo' }}</span>
                </label>
            </div>
            <div class="form-row">
                <label for="editTipoDato">Tipo de Dato</label>
                <select id="editTipoDato" [(ngModel)]="editarSensor.tipoDato" name="editTipoDato">
                    <option *ngFor="let t of tiposDato" [value]="t.value">{{ t.label }}</option>
                </select>
            </div>
            <div *ngIf="!isTipoBooleano(editarSensor.tipoDato)" class="form-row dual"
                [ngClass]="{'range-invalid': editarSensor.minValue !== null && editarSensor.maxValue !== null && editarSensor.minValue > editarSensor.maxValue}">
                <div class="dual-field min-field">
                    <label for="editMinValue">Valor M√≠nimo</label>
                    <div class="input-wrapper">
                        <span class="prefix">MIN</span>
                        <input id="editMinValue" type="number" step="0.0001" [(ngModel)]="editarSensor.minValue"
                            name="editMinValue" placeholder="Ej: 0" />
                    </div>
                </div>
                <div class="dual-field max-field">
                    <label for="editMaxValue">Valor M√°ximo</label>
                    <div class="input-wrapper">
                        <span class="prefix">MAX</span>
                        <input id="editMaxValue" type="number" step="0.0001" [(ngModel)]="editarSensor.maxValue"
                            name="editMaxValue" placeholder="Ej: 100" />
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" (click)="closeEditSensorModal()"
                    [disabled]="editingSensor">Cancelar</button>
                <button type="submit" class="btn-save"
                    [disabled]="editingSensor || !editarSensor.key.trim() || !editarSensor.nombre.trim()">
                    <span *ngIf="!editingSensor">Guardar Cambios</span>
                    <span *ngIf="editingSensor" class="spinner"></span>
                </button>
            </div>
        </form>
    </div>
</div>