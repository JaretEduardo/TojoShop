<div class="purchasing-container">
    <!-- Encabezado -->
    <div class="purchasing-header">
        <h2>Herramienta de Compras</h2>
        <div class="header-subtitle">GestiÃ³n de recepciÃ³n de productos e inventario</div>
    </div>

    <!-- Contenedor principal -->
    <div class="main-content">

        <!-- SecciÃ³n superior: Tabla/Lista de productos -->
        <div class="products-section">
            <div class="section-header">
                <h3>Productos en Compra Actual</h3>
                <div class="purchase-summary" *ngIf="productosEnCompra.length > 0">
                    <span class="summary-item">
                        <strong>{{ productosEnCompra.length }}</strong> productos
                    </span>
                    <span class="summary-item">
                        <strong>{{ getTotalUnidades() }}</strong> unidades
                    </span>
                    <span class="summary-item total">
                        <strong>${{ montoTotal.toFixed(2) }} MXN</strong>
                    </span>
                </div>
            </div>

            <!-- div5: Contenedor de la tabla -->
            <div class="products-table" *ngIf="productosEnCompra.length > 0; else emptyTable">
                <!-- Encabezados de tabla -->
                <div class="table-header">
                    <!-- div6 equivalent -->
                    <div class="header-cell codigo">CÃ³digo</div>
                    <!-- div7 equivalent -->
                    <div class="header-cell nombre">Nombre del Producto</div>
                    <!-- div8 equivalent -->
                    <div class="header-cell inventario">Inventario Actual</div>
                    <!-- div9 equivalent -->
                    <div class="header-cell recibir">Piezas a Recibir</div>
                    <!-- div10 equivalent -->
                    <div class="header-cell precio">Precio Unitario</div>
                    <div class="header-cell subtotal">Subtotal</div>
                    <div class="header-cell acciones">Acciones</div>
                </div>

                <!-- Filas de productos -->
                <div class="table-row" *ngFor="let productoCompra of productosEnCompra; let i = index">
                    <div class="table-cell codigo">{{ productoCompra.producto.codigo }}</div>
                    <div class="table-cell nombre">{{ productoCompra.producto.nombre }}</div>
                    <div class="table-cell inventario">{{ productoCompra.producto.inventarioTeorico }}</div>
                    <div class="table-cell recibir">
                        <span class="quantity-badge">{{ productoCompra.cantidadARecibir }}</span>
                    </div>
                    <div class="table-cell precio">${{ productoCompra.producto.precioUnitario.toFixed(2) }}</div>
                    <div class="table-cell subtotal">${{ productoCompra.subtotal.toFixed(2) }}</div>
                    <div class="table-cell acciones">
                        <button class="remove-btn" (click)="eliminarProducto(i)" title="Eliminar producto">
                            <span class="remove-icon">âœ•</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Estado vacÃ­o -->
            <ng-template #emptyTable>
                <div class="empty-state">
                    <div class="empty-icon">ðŸ“¦</div>
                    <div class="empty-title">No hay productos en la compra actual</div>
                    <div class="empty-subtitle">Agregue productos usando el formulario inferior</div>
                </div>
            </ng-template>
        </div>

        <!-- SecciÃ³n inferior: Formulario de control de compra -->
        <div class="purchase-form-section">
            <div class="section-header">
                <h3>Agregar Producto a la Compra</h3>
            </div>

            <div class="purchase-form">
                <!-- div1: ID del producto -->
                <div class="form-group product-id-group">
                    <label for="productoId">ID/CÃ³digo del Producto</label>
                    <div class="input-with-suggestions">
                        <input type="text" id="productoId" [(ngModel)]="productoId" name="productoId"
                            placeholder="Ej: LAC001 o Leche..." class="form-input" autocomplete="off">

                        <!-- Sugerencias de autocompletado -->
                        <div class="suggestions-dropdown" *ngIf="getSugerenciasProductos().length > 0">
                            <div class="suggestion-item" *ngFor="let producto of getSugerenciasProductos()"
                                (click)="seleccionarProducto(producto)">
                                <span class="suggestion-code">{{ producto.codigo }}</span>
                                <span class="suggestion-name">{{ producto.nombre }}</span>
                                <span class="suggestion-price">${{ producto.precioUnitario.toFixed(2) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- div2: Unidades a ingresar -->
                <div class="form-group">
                    <label for="unidades">Unidades a Recibir</label>
                    <input type="number" id="unidades" [(ngModel)]="unidadesAIngresar" name="unidades" placeholder="0"
                        min="1" class="form-input" step="1">
                </div>

                <!-- div3: Monto total (solo lectura/informativo) -->
                <div class="form-group total-group">
                    <label>Total de la Compra</label>
                    <div class="total-display">
                        <span class="currency">$</span>
                        <span class="amount">{{ montoTotal.toFixed(2) }}</span>
                        <span class="currency-code">MXN</span>
                    </div>
                </div>

                <!-- Botones de acciÃ³n -->
                <div class="form-actions">
                    <button type="button" class="add-btn" (click)="agregarProducto()"
                        [disabled]="!isProductoIdValid() || unidadesAIngresar <= 0">
                        <span class="btn-icon">+</span>
                        <span class="btn-text">Agregar Producto</span>
                    </button>

                    <!-- div4: BotÃ³n para cerrar la compra -->
                    <button type="button" class="close-purchase-btn" (click)="cerrarCompra()"
                        [disabled]="!puedeSerrarCompra()">
                        <span class="btn-icon">âœ“</span>
                        <span class="btn-text">Cerrar Compra</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmaciÃ³n para cerrar compra -->
<div class="modal-overlay" *ngIf="mostrarModalConfirmacion" (click)="cancelarCierreCompra()">
    <div class="confirmation-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Confirmar Cierre de Compra</h3>
            <button class="modal-close-btn" (click)="cancelarCierreCompra()">Ã—</button>
        </div>
        
        <div class="modal-content">
            <p class="confirmation-message">
                Â¿EstÃ¡s seguro de que deseas cerrar esta compra? Los productos serÃ¡n agregados al inventario.
            </p>
        </div>
        
        <div class="modal-actions">
            <button class="cancel-btn" (click)="cancelarCierreCompra()">Cancelar</button>
            <button class="confirm-btn" (click)="confirmarCierreCompra()">Confirmar Compra</button>
        </div>
    </div>
</div>

<!-- Modal de confirmaciÃ³n para limpiar compra -->
<div class="modal-overlay" *ngIf="mostrarModalLimpiar" (click)="cancelarLimpieza()">
    <div class="confirmation-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Confirmar Limpieza</h3>
            <button class="modal-close-btn" (click)="cancelarLimpieza()">Ã—</button>
        </div>
        
        <div class="modal-content">
            <p class="confirmation-message">
                Â¿EstÃ¡s seguro de que deseas limpiar la compra actual? Se perderÃ¡n 
                <strong>{{ productosEnCompra.length }}</strong> productos por un valor de 
                <strong>${{ montoTotal.toFixed(2) }} MXN</strong>.
            </p>
        </div>
        
        <div class="modal-actions">
            <button class="cancel-btn" (click)="cancelarLimpieza()">Cancelar</button>
            <button class="confirm-btn danger" (click)="confirmarLimpieza()">Limpiar Compra</button>
        </div>
    </div>
</div>